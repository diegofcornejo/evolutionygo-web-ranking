---
import Layout from '@layouts/Layout.astro';
import ProfileHeader from '@components/Profile/ProfileHeader';
import StatsOverview from '@components/Profile/StatsOverview';
import MatchHistory from '@components/Profile/MatchHistory';
import AchievementShowcase from '@components/Profile/AchievementShowcase';
import SeasonSelector from '@components/Profile/SeasonSelector.astro';
import type { Match } from '@types';

let { id, banlist = 'Global' } = Astro.params;
const username = Astro.url.searchParams.get('username') || '';
const season = Astro.url.searchParams.get('season') || import.meta.env.PUBLIC_DEFAULT_SEASON;
const API_URL = import.meta.env.PUBLIC_API_URL;

const safeBanlist = banlist ?? 'Global';
let banlistName = safeBanlist;

if (safeBanlist === 'Global') {
	banlistName = '';
}

let duelist;
const duelistResponse = await fetch(
	`${API_URL}/users/${id}/stats?season=${season}${banlistName ? `&banListName=${banlistName}` : ''}`,
);
if (!duelistResponse.ok) {
	duelist = {
		userId: id ?? '',
		username,
		points: 0,
		wins: 0,
		losses: 0,
		winRate: 0,
		position: 0,
		achievements: [],
	};
} else {
	duelist = await duelistResponse.json();
}

const createMockMatches = (name: string): Match[] => [
	{
		userId: id ?? '0',
		bestOf: 3,
		banListName: banlistName || 'Global',
		playerNames: [name || 'Duelist'],
		opponentNames: ['NebulaX'],
		playerScore: 2,
		opponentScore: 1,
		points: 25,
		winner: true,
		date: new Date().toISOString(),
		season: parseInt(season),
	},
	{
		userId: id ?? '0',
		bestOf: 1,
		banListName: banlistName || 'Global',
		playerNames: [name || 'Duelist'],
		opponentNames: ['ShadowMage'],
		playerScore: 0,
		opponentScore: 1,
		points: -12,
		winner: false,
		date: new Date(Date.now() - 86400000).toISOString(),
		season: parseInt(season),
	},
	{
		userId: id ?? '0',
		bestOf: 3,
		banListName: banlistName || 'Global',
		playerNames: [name || 'Duelist'],
		opponentNames: ['CelestialRex'],
		playerScore: 2,
		opponentScore: 0,
		points: 30,
		winner: true,
		date: new Date(Date.now() - 172800000).toISOString(),
		season: parseInt(season),
	},
];

let matchHistory: Match[] = [];
const matchHistoryResponse = await fetch(
	`${API_URL}/users/${id}/matches?page=1&limit=100&season=${season}${banlistName ? `&banListName=${banlistName}` : ''}`,
);
	if (!matchHistoryResponse.ok) {
		matchHistory = createMockMatches(duelist.username || username);
	} else {
		matchHistory = await matchHistoryResponse.json();
		if (!matchHistory?.length) {
			matchHistory = [];
		} else {
			const matchesPerPage = 100;
			let page = 2;
			let shouldContinue = matchHistory.length === matchesPerPage;

			while (shouldContinue) {
				const pagedResponse = await fetch(
					`${API_URL}/users/${id}/matches?page=${page}&limit=${matchesPerPage}&season=${season}${banlistName ? `&banListName=${banlistName}` : ''}`,
				);

				if (!pagedResponse.ok) {
					break;
				}

				const pageMatches = await pagedResponse.json();
				if (!pageMatches?.length) {
					break;
				}

				matchHistory = matchHistory.concat(pageMatches);
				page += 1;
				shouldContinue = pageMatches.length === matchesPerPage;
			}
		}
	}


const banlistResponse = await fetch(`${API_URL}/ban-lists?season=${season}`);
const banListOptions = await banlistResponse.json();
const seasonOptions = Array.from(
	{ length: parseInt(import.meta.env.PUBLIC_DEFAULT_SEASON) },
	(_, index) => `${index + 1}`,
).reverse();

---

<!-- TODO: This could be refactored to a react component, at this time it's to learn how to do this in astro -->
<script is:inline>
	document.addEventListener('DOMContentLoaded', () => {
		const seasonSelect = document.getElementById('season-select');
		const banlistSelect = document.getElementById('banlist-select');
		const dataElement = document.querySelector('[data-id]');
		const id = dataElement?.getAttribute('data-id') || null;
		const username = dataElement?.getAttribute('data-username') || null;

		const reloadDuelistPage = () => {
			const season = seasonSelect?.value || null;
			const banlist = banlistSelect?.value || null;

			const newUrl = new URL(`${window.location.origin}/duelists/${id}/${banlist}`);
			newUrl.searchParams.set('username', username || '');
			newUrl.searchParams.set('season', season || '');

			window.location.href = newUrl.toString();
		};

		seasonSelect?.addEventListener('change', reloadDuelistPage);
		banlistSelect?.addEventListener('change', reloadDuelistPage);
	});
</script>

<Layout 
	title={`Duelist ${duelist.username} Stats`}
	description={`Check out ${duelist.username}'s stats, match history, and achievements in Evolution YGO Season ${season}. Wins: ${duelist.wins}, Losses: ${duelist.losses}, Win Rate: ${duelist.winRate}%.`}
	image={`https://ui-avatars.com/api/?name=${encodeURIComponent(duelist.username)}&background=random&size=512`}
	type="profile"
	keywords={[
		duelist.username,
		'Yu-Gi-Oh player',
		'duelist stats',
		'YGO ranking',
		`Season ${season}`,
		banlistName || 'Global',
		'match history',
		'player profile'
	]}
	jsonLd={{
		'@context': 'https://schema.org',
		'@type': 'ProfilePage',
		mainEntity: {
			'@type': 'Person',
			name: duelist.username,
			identifier: id,
			description: `Yu-Gi-Oh! duelist on Evolution YGO with ${duelist.wins} wins and ${duelist.losses} losses.`,
			interactionStatistic: [
				{
					'@type': 'InteractionCounter',
					interactionType: 'https://schema.org/WinAction',
					userInteractionCount: duelist.wins
				},
				{
					'@type': 'InteractionCounter',
					interactionType: 'https://schema.org/LoseAction',
					userInteractionCount: duelist.losses
				}
			]
		}
	}}
>
	<main class='w-full max-w-[calc(100%_-_2rem)] mx-auto my-6 text-base-content'>
	<section class="space-y-6">
		<SeasonSelector
			seasonOptions={seasonOptions}
			banListOptions={banListOptions}
			currentSeason={season}
			currentBanlist={safeBanlist}
			userId={id ?? ''}
			username={duelist.username}
		/>

		<div class="grid grid-cols-1 xl:grid-cols-[1.1fr_1.4fr] gap-6 items-start">
			<ProfileHeader
				userId={id ?? ''}
				username={duelist.username}
				points={duelist.points}
				wins={duelist.wins}
				losses={duelist.losses}
				winRate={duelist.winRate}
				position={duelist.position}
				season={season}
				banlistName={banlistName || 'Global'}
			/>

			<div class="space-y-6">
				<StatsOverview
					wins={duelist.wins}
					losses={duelist.losses}
					winRate={duelist.winRate}
					points={duelist.points}
					position={duelist.position}
				/>

				<div>
					<AchievementShowcase achievements={duelist.achievements} client:load />
				</div>
			</div>
		</div>
	</section>

	<section class="mt-12">
		<div class="flex items-center justify-between mb-4">
			<h2 class="text-2xl font-bold">Match History</h2>
			<span class="text-sm text-base-content/60">Recent duels</span>
		</div>
		<MatchHistory matches={matchHistory} currentUsername={duelist.username} client:load />
	</section>
	</main>
</Layout>
